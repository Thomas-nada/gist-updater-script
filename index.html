<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardano Stake Pool Governance Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .table-header {
            background-color: #374151;
        }
        .table-row-dark {
            background-color: #1f2937;
        }
        .table-row-light {
            background-color: #263142;
        }
        .search-input {
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.75rem;
            line-height: 1rem;
        }
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">Cardano Stake Pool Governance Report</h1>
            <p class="text-gray-400">Displaying live data from your automated Gist.</p>
        </div>

        <!-- Summary Cards -->
        <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- Cards will be injected by JS -->
        </div>

        <!-- Filters -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6 p-4 card rounded-lg">
            <div class="flex-grow">
                <label for="search-input" class="block text-sm font-medium text-gray-300 mb-1">Search Pools</label>
                <input type="text" id="search-input" placeholder="Search by ticker, ID, or homepage..." class="w-full p-2 rounded-md search-input focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div>
                <label for="vote-filter" class="block text-sm font-medium text-gray-300 mb-1">Filter by Vote</label>
                <select id="vote-filter" class="w-full sm:w-auto p-2 rounded-md search-input focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <option value="all">All Votes</option>
                    <option value="Always Abstain">Always Abstain</option>
                    <option value="Always No Confidence">Always No Confidence</option>
                    <option value="Other">Other</option>
                    <option value="Not Delegated">Not Delegated</option>
                </select>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="table-header">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ticker</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Pool ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Homepage</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Voting Power (ADA)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Vote</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-700">
                        <!-- Rows will be injected by JS -->
                    </tbody>
                </table>
                 <!-- Loading and Error States -->
                <div id="loading-state" class="flex justify-center items-center p-10">
                    <div class="loader"></div>
                </div>
                <div id="error-state" class="hidden text-center p-10">
                    <p class="text-red-400 font-semibold">Could not load data.</p>
                    <p class="text-gray-400 text-sm">There might be an issue with the Gist URL or network connection.</p>
                </div>
                 <div id="no-results-state" class="hidden text-center p-10">
                    <p class="text-gray-400 font-semibold">No matching pools found.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIG ---
            const GIST_URL = 'https://gist.githubusercontent.com/Thomas-nada/7b742a3ca9e42281ae831b3da689c0b5/raw/governance-report.csv';
            // The CORS proxy was removed as it was likely causing the 403 Forbidden error.
            const DATA_URL = GIST_URL;

            // --- DOM ELEMENTS ---
            const tableBody = document.getElementById('table-body');
            const summaryContainer = document.getElementById('summary-cards');
            const searchInput = document.getElementById('search-input');
            const voteFilter = document.getElementById('vote-filter');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const noResultsState = document.getElementById('no-results-state');

            let originalData = [];

            // --- VOTE STYLING MAP ---
            const voteStyles = {
                'Always Abstain': 'bg-yellow-900/50 text-yellow-300 border border-yellow-700',
                'Always No Confidence': 'bg-red-900/50 text-red-300 border border-red-700',
                'Other': 'bg-blue-900/50 text-blue-300 border border-blue-700',
                'Not Delegated': 'bg-gray-700/50 text-gray-300 border border-gray-600'
            };

            // --- DATA FETCHING ---
            async function fetchData() {
                try {
                    const data = await d3.csv(DATA_URL);
                    originalData = data.map(d => ({
                        ...d,
                        voting_power_ada: parseFloat(d.voting_power_ada) || 0
                    }));
                    
                    loadingState.style.display = 'none';
                    renderAll();
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loadingState.style.display = 'none';
                    errorState.style.display = 'block';
                }
            }

            // --- RENDERING FUNCTIONS ---
            function renderAll() {
                const filteredData = filterData();
                renderSummary(filteredData);
                renderTable(filteredData);
            }

            function renderSummary(data) {
                const totalPools = data.length;
                const totalPower = data.reduce((sum, d) => sum + d.voting_power_ada, 0);
                const voteCounts = d3.rollup(data, v => v.length, d => d.vote);

                const cards = [
                    { label: 'Total Pools', value: totalPools.toLocaleString() },
                    { label: 'Total Voting Power', value: `${Math.round(totalPower / 1_000_000).toLocaleString()}M ADA` },
                    { label: 'Abstain', value: (voteCounts.get('Always Abstain') || 0).toLocaleString() },
                    { label: 'No Confidence', value: (voteCounts.get('Always No Confidence') || 0).toLocaleString() }
                ];

                summaryContainer.innerHTML = cards.map(card => `
                    <div class="card rounded-lg p-4">
                        <p class="text-sm text-gray-400">${card.label}</p>
                        <p class="text-2xl font-bold text-white">${card.value}</p>
                    </div>
                `).join('');
            }

            function renderTable(data) {
                tableBody.innerHTML = ''; // Clear existing rows
                
                if (data.length === 0) {
                    noResultsState.style.display = 'block';
                    return;
                }
                noResultsState.style.display = 'none';

                data.forEach((d, i) => {
                    const rowClass = i % 2 === 0 ? 'table-row-dark' : 'table-row-light';
                    const voteClass = voteStyles[d.vote] || voteStyles['Not Delegated'];
                    const row = document.createElement('tr');
                    row.className = `${rowClass} hover:bg-gray-700/50 transition-colors duration-150`;

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${d.ticker || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" title="${d.pool_id}">
                            ${d.pool_id.substring(0, 12)}...
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                            ${d.homepage ? `<a href="${d.homepage}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">${d.homepage.replace(/^(https?:\/\/)?(www\.)?/, '')}</a>` : 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${d.voting_power_ada.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="tag ${voteClass}">${d.vote}</span>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // --- FILTERING LOGIC ---
            function filterData() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedVote = voteFilter.value;

                return originalData.filter(d => {
                    const matchesSearch = searchTerm === '' ||
                        (d.ticker && d.ticker.toLowerCase().includes(searchTerm)) ||
                        (d.pool_id && d.pool_id.toLowerCase().includes(searchTerm)) ||
                        (d.homepage && d.homepage.toLowerCase().includes(searchTerm));

                    const matchesVote = selectedVote === 'all' || d.vote === selectedVote;

                    return matchesSearch && matchesVote;
                });
            }

            // --- EVENT LISTENERS ---
            searchInput.addEventListener('input', renderAll);
            voteFilter.addEventListener('change', renderAll);

            // --- INITIAL LOAD ---
            fetchData();
        });
    </script>

</body>
</html>
